document.addEventListener("DOMContentLoaded", () => {
    const container = document.querySelector("#eventstable");
    if (!container) return;

    container.innerHTML = ""; // –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

    // -------------------------
    // 1) –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–æ–±—ã—Ç–∏—è—Ö –∏–∑ users (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –µ—Å—Ç—å)
    // -------------------------
    const eventsMap = {};
    for (const userId in users) {
        const user = users[userId];
        (user.events || []).forEach(eventId => {
            if (!eventsMap[eventId]) {
                eventsMap[eventId] = { players: [], awards: {} };
            }
            eventsMap[eventId].players.push(user.gamename || user.id);

            (user.awards || []).forEach(awardId => {
                const award = awards && awards[awardId];
                if (award && award.event === eventId) {
                    if (!eventsMap[eventId].awards[awardId]) {
                        eventsMap[eventId].awards[awardId] = { award, players: [] };
                    }
                    eventsMap[eventId].awards[awardId].players.push(user.gamename || user.id);
                }
            });
        });
    }

    // -------------------------
    // 2) –ü–∞—Ä—Å–µ—Ä –¥–∞—Ç -> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Date (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏) –∏–ª–∏ null
    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: DD.MM.YYYY, DD.MM.YY, YYYY-MM-DD –∏ ISO-–ø–æ–¥–æ–±–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    // -------------------------
    function parseDateToDateObject(str) {
        if (!str) return null;
        str = String(str).trim();

        // DD.MM.YYYY –∏–ª–∏ DD.MM.YY
        let m = str.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})$/);
        if (m) {
            let day = parseInt(m[1], 10);
            let month = parseInt(m[2], 10);
            let year = parseInt(m[3], 10);
            if (year < 100) {
                // 2-digit year: 00-69 -> 2000-2069, 70-99 -> 1970-1999
                year += (year >= 70 ? 1900 : 2000);
            }
            const d = new Date(year, month - 1, day);
            if (!isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
            return null;
        }

        // YYYY-MM-DD
        m = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (m) {
            const year = parseInt(m[1], 10);
            const month = parseInt(m[2], 10);
            const day = parseInt(m[3], 10);
            const d = new Date(year, month - 1, day);
            if (!isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
            return null;
        }

        // –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ (ISO –∏ —Ç.–ø.)
        const dt = new Date(str);
        if (!isNaN(dt)) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());

        return null;
    }

    // —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è DD.MM.YYYY
    function formatDateDDMMYYYY(dateObj) {
        if (!dateObj) return "";
        const dd = String(dateObj.getDate()).padStart(2, "0");
        const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
        const yyyy = String(dateObj.getFullYear());
        return `${dd}.${mm}.${yyyy}`;
    }

    // isPast: true –µ—Å–ª–∏ –¥–∞—Ç–∞ —Å—Ç—Ä–æ–≥–æ –º–µ–Ω—å—à–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏)
    function isPast(dateObj) {
        if (!dateObj) return false;
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        return dateObj.getTime() < today.getTime();
    }

    // -------------------------
    // 3) –°—Ç—Ä–æ–∏–º eventsArray –ü–û –í–°–ï–ú —Å–æ–±—ã—Ç–∏—è–º (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–º, –≥–¥–µ –µ—Å—Ç—å –∏–≥—Ä–æ–∫–∏)
    // -------------------------
    const eventsArray = Object.keys(events).map(eventId => {
        const info = events[eventId] || {};
        const mapData = eventsMap[eventId] || { players: [], awards: {} };
        const parsedDate = parseDateToDateObject(info.date); // Date –∏–ª–∏ null
        return {
            eventId,
            data: mapData,
            info,
            dateObj: parsedDate
        };
    });

    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –ø—Ä–æ—à–µ–¥—à–∏–µ / –±—É–¥—É—â–∏–µ
    const pastEvents = [];
    const futureEvents = [];
    eventsArray.forEach(e => {
        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã ‚Äî –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ–∫—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å.
        // –°–µ–π—á–∞—Å: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–±—ã—Ç–∏—è –±–µ–∑ –¥–∞—Ç—ã
        if (!e.dateObj) return;
        if (isPast(e.dateObj)) {
            pastEvents.push(e);
        } else {
            futureEvents.push(e);
        }
    });

    // -------------------------
    // 4) –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    // –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –±—É–¥—É—â–∏–µ –Ω–∞–¥ –ø—Ä–æ—à–µ–¥—à–∏–º–∏, –∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π —Å–µ–∫—Ü–∏–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤—ã—à–µ.
    // –ó–Ω–∞—á–∏—Ç: —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –¥–∞—Ç—ã (b - a)
    // -------------------------
    pastEvents.sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime());
    futureEvents.sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime());

    // -------------------------
    // 5) –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–æ–±—ã—Ç–∏—è
    // -------------------------
    function createCard({ eventId, data, info, dateObj }, time) {
        const card = document.createElement("div");
        card.className = "event-card";
        if (info.map) {
            let mapId = info.map.replace(/^([^_]*_[^_]*)_.*$/, '$1');
            mapId = mapId.replace(/_/g, '/');
            if (window.location.href.includes('file:///')) {
            card.style.backgroundImage = `url("http://192.168.100.18:8081/lib/${mapId}/${info.map}.png")`;
            } else {
            card.style.backgroundImage = `url("http://raw.githubusercontent.com/EEditor-WS/eeditor-ws-data/refs/heads/main/lib/${mapId}/${info.map}.png")`;
            }
        } else if (info.img) card.style.backgroundImage = `url("img/events/${info.img}")`;
        card.style.backgroundSize = "cover";
        card.style.backgroundPosition = "center";
        card.style.borderRadius = "0.4rem";
        card.style.padding = "1rem";
        card.style.marginBottom = "1rem";
        card.style.color = "#fff";
        card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.4)";
        if (time === 'future') card.style.border = "5px solid #939347"; // –∂–µ–ª—Ç–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö —Å–æ–±—ã—Ç–∏–π
        if (info.canceled) card.style.border = "5px solid #934747ff"; // –∂–µ–ª—Ç–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

        const extrabtnsdiv = document.createElement("div");
        extrabtnsdiv.className = 'extrabtnsdiv';
        if (info.discord) extrabtnsdiv.innerHTML = `<button class="extrabtn discord" onclick="window.open('https://discord.com/channels/1194999547571744888/${info.discord}')"><img src="img/icons/discord-white.svg"></button>`;
        // extrabtnsdiv.innerHTML = extrabtnsdiv.innerHTML + `<button class="extrabtn" onclick="downloadScenario('${info.map}')"><img src="img/icons/download.svg"></button>`
        extrabtnsdiv.innerHTML = extrabtnsdiv.innerHTML + `<button class="extrabtn" onclick="window.open('https://eeditor-ws.github.io/page/library/download?fullid=${info.map}')"><img src="img/icons/download.svg"></button>`
        card.appendChild(extrabtnsdiv);

        const overlay = document.createElement("div");
        // –∑–∞—Ç–µ–º–Ω—è—é—â–∏–π —Ñ–æ–Ω, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è –Ω–∞ —è—Ä–∫–æ–º —Ñ–æ–Ω–µ
        // overlay.style.background = "rgba(0,0,0,0.45)";
        overlay.style.padding = "0.5rem";
        overlay.style.borderRadius = "0.6rem";

        const title = document.createElement("h2");
        title.textContent = info.name || eventId;
        overlay.appendChild(title);

        // /--------------------------------------------\
        let finaltime = '';
        let moscowISOString;
        const [day, month, year] = info.date.split('.'); 
        const isoDatePart = `${year}-${month}-${day}`;
        if (info.time)  { moscowISOString = `${isoDatePart}T${info.time}:00+03:00` }
        else            { moscowISOString = `${isoDatePart}T${'19:00'}:00+03:00` };
        const eventDate = new Date(moscowISOString);
        const options = {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZoneName: 'short'
        };
        finaltime = eventDate.toLocaleString(
            navigator.language,
            options
        );

        const date = document.createElement("p");
        date.textContent = finaltime || info.date || formatDateDDMMYYYY(dateObj) || "";
        overlay.appendChild(date);
        // \--------------------------------------------/

        const players = document.createElement("p");
        players.textContent = "Players: " + (data.players.length ? data.players.join(", ") : "-");
        players.style.maxHeight = '35px';
        players.style.overflowY = 'auto';
        overlay.appendChild(players);

        const medals = document.createElement("div");
        medals.style.display = "flex";
        medals.style.gap = "8px";
        medals.style.marginTop = "0.5rem";

        for (const awardId in data.awards) {
            const obj = data.awards[awardId];
            const img = document.createElement("img");
            img.src = "img/award/" + (obj.award.img || "noimg.png");
            img.alt = obj.award.name || "";
            img.title = obj.award.name || "";
            img.style.width = "32px";
            img.style.height = "32px";
            img.style.cursor = "pointer";

            img.onclick = () => {
                window.leaderboard.showAward(awardId);
                //alert(`üèÖ ${obj.award.name}\n–ü–æ–ª—É—á–∏–ª–∏: ${obj.players.join(", ")}`);
            };

            medals.appendChild(img);
        }

        overlay.appendChild(medals);
        card.appendChild(overlay);
        return card;
    }

    // -------------------------
    // 6) –†–µ–Ω–¥–µ—Ä: —Å–Ω–∞—á–∞–ª–∞ –±—É–¥—É—â–∏–µ, –∑–∞—Ç–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, –∑–∞—Ç–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ
    // -------------------------
    // –±—É–¥—É—â–µ–µ
    if (futureEvents.length) {
        /*const futureTitle = document.createElement("h3");
        futureTitle.textContent = "–ë—É–¥—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è:";
        futureTitle.style.margin = "0.5rem 0 1rem 0";
        container.appendChild(futureTitle);*/

        futureEvents.forEach(e => container.appendChild(createCard(e, 'future')));
    }

    // —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ —Ç–µ, –∏ –¥—Ä—É–≥–∏–µ)
    if (pastEvents.length && futureEvents.length) {
        const divider = document.createElement("div");
        divider.innerHTML = `
            <div class="ads" style="padding: 1rem; background: #333; color: #fff; text-align: center; border-radius: 0.5rem;">
                üåü Here will be advertising of <a href="https://eeditor-ws.vercel.app/">EEditor - best scenario editor for Warnament</a> üåü
                <br>
                <br>
                üåü –¢—É—Ç –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∫–ª–∞–º–∞ <a href="https://eeditor-ws.github.io/">EEditor'–∞ - –ª—É—á—à–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è Warnament</a> üåü
            </div>
        `;
        container.appendChild(divider);
    }

    // –ø—Ä–æ—à–µ–¥—à–∏–µ
    if (pastEvents.length) {
        const pastTitle = document.createElement("h3");
        /*pastTitle.textContent = "–ü—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è:";
        pastTitle.style.margin = "1rem 0 0.5rem 0";
        container.appendChild(pastTitle);*/

        pastEvents.forEach(e => container.appendChild(createCard(e)));
    }

    // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    // console.log('–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π (events):', Object.keys(events).length);
    // console.log('–°–æ–±—ã—Ç–∏–π —Å –∏–≥—Ä–æ–∫–∞–º–∏ (eventsMap):', Object.keys(eventsMap).length);
    // console.log('–ë—É–¥—É—â–∏–µ:', futureEvents.map(e => ({ id: e.eventId, date: formatDateDDMMYYYY(e.dateObj) })));
    // console.log('–ü—Ä–æ—à–µ–¥—à–∏–µ:', pastEvents.map(e => ({ id: e.eventId, date: formatDateDDMMYYYY(e.dateObj) })));
});

async function downloadFile(url, fileName) {
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }

    const contentType = response.headers.get('content-type') || 'application/octet-stream';
    const blob = await response.blob();
    const enhancedBlob = new Blob([blob], { type: contentType });

    const link = document.createElement('a');
    link.href = URL.createObjectURL(enhancedBlob);
    link.download = fileName;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(link.href);
    return new Promise(resolve => setTimeout(resolve, 100));
}

async function downloadScenario(id) {
    // –†–∞–∑–±–∏–≤–∞–µ–º id –Ω–∞ —á–∞—Å—Ç–∏, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è —Ñ–æ—Ä–º–∞—Ç '—á–∞—Å—Ç—å1_—á–∞—Å—Ç—å2_—á–∞—Å—Ç—å3_—á–∞—Å—Ç—å4'
    const parts = id.split('_');

    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ –¥–≤–µ —á–∞—Å—Ç–∏ –∏ —Å–æ–µ–¥–∏–Ω—è–µ–º –∏—Ö —á–µ—Ä–µ–∑ '/'.
    // –ù–∞–ø—Ä–∏–º–µ—Ä, 'parkourcat_euro4_vg_1956' -> 'parkourcat/euro4'
    const scenarioPath = parts.slice(0, 2).join('/');

    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.
    // –ï—Å–ª–∏ id = 'parkourcat_euro4_vg_1956', —Ç–æ filePath –±—É–¥–µ—Ç:
    // https://raw.githubusercontent.com/EEditor-WS/eeditor-ws-data/refs/heads/main/lib/parkourcat/euro4
    const filePath = `https://raw.githubusercontent.com/EEditor-WS/eeditor-ws-data/refs/heads/main/lib/${scenarioPath}/${id}.json`;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —á–∞—Å—Ç—å id –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    const fileName = `${id}.json`; 

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
    await downloadFile(filePath, fileName);
}